include required(classpath("application"))

backend {
  default = "ContainerisedLSF"

  providers {
    ContainerisedLSF {
      actor-factory = "cromwell.backend.impl.sfs.config.ConfigBackendLifecycleActorFactory"
      config {
        concurrent-job-limit = 100
        run-in-background = true

        runtime-attributes = """
          # LSF attributes
          String  lsf_group              # Fairshare group
          String? lsf_queue  = "normal"  # Queue name
          Int?    lsf_cores  = 1         # CPU requirement
          Int?    lsf_memory = 1000      # Memory (MB) requirement

          # Containerisation attributes
          String? docker                 # Docker image
          String? singularity            # Singularity image
          # Array[String]? mounts = []     # List of directories to mount

          # Mode attributes
          Boolean is_singularity = if singularity then true else false
        """

        # TODO Directory mounting
        submit = """
          submit.sh ${if is_singularity then "singularity " + singularity else "vanilla"} \
                    --name "${job_name}" \
                    --group "${lsf_group}" \
                    --queue "${lsf_queue}" \
                    --cores "${lsf_cores}" \
                    --memory "${lsf_memory}" \
                    --working "${cwd}" \
                    --stdout "${out}" \
                    --stderr "${err}" \
                    -- ${script}
        """

        # TODO Directory mounting
        # FIXME? Hardcoded LSF's stdout and stderr to get around
        # Cromwell's Docker assumptions. It presumes that the CWD-based
        # path will always be correct...which it probably won't be.
        submit-docker = """
          submit.sh docker "${docker}" \
                    --name "${job_name}" \
                    --group "${lsf_group}" \
                    --queue "${lsf_queue}" \
                    --cores "${lsf_cores}" \
                    --memory "${lsf_memory}" \
                    --mount "${cwd}:${docker_cwd}" \
                    --container-working "${docker_cwd}" \
                    --working "${cwd}" \
                    --stdout "${cwd}/execution/stdout.lsf" \
                    --stderr "${cwd}/execution/stderr.lsf" \
                    -- ${script}
        """

        job-id-regex = "Job <(\\d+)>.*"

        kill = "bkill ${job_id}"

        check-alive = "bjobs ${job_id}"
      }
    }
  }
}
